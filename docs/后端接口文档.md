# 后端接口文档（对齐前端接口定义）

[返回文档索引](索引.md) · [查看产品与需求](需求.md) · [查看架构总览](architecture/架构-总览.md)

本文档与前端 `src/api/endpoints.ts` 保持一致，记录已实现接口的合同与示例，便于联调与自测。

通用约定：

- 基础地址（Base URL）：开发环境通过代理 `/api` → `http://localhost:5177`；生产环境可通过 `VITE_API_BASE` 配置。
- 认证：如需，走 `Authorization: Bearer <token>`（当前未启用强校验）。
- 统一响应：`{ code: 0, message: 'ok', data: ... }`；`code != 0` 表示业务错误。
- 金额单位：后端存储以“分”为单位（Int）；前端展示/输入多为“元”，提交时已转换为“分”。


---

## 用户画像 / 计划进度

### GET /api/v1/user/profile

返回示例：

```json
{"code":0,"data":{"userId":"user-001","riskLevel":"MID","preferences":{"food":0.4,"travel":0.2},"tags":["都市白领","理性消费","偏好餐饮"]}}
```

### GET /api/v1/user/profile/tags

返回示例：

```json
{"code":0,"data":{"groups":[{"group":"基本画像","tags":["25-34","一线城市"]},{"group":"消费能力","tags":["月均5k-10k"]},{"group":"风险偏好","tags":["稳健"]}],"total":3}}
```

### GET /api/v1/plan/progress?goalId=

返回 `PlanProgress[]`，字段：`goalId`、`progress(0-1)`、`updatedAt`。

---

## 票据识别与分类

### POST /api/v1/accounting/classify

表单：`image` 可多文件。返回：

```json
{"code":0,"data":{"ocr":[{"text":"Image#1:upload_0.jpg"}],"categories":[{"label":"餐饮","score":0.86},{"label":"购物","score":0.33}],"amount":19.99,"merchant":"示例商户","ts":"2025-11-13T00:00:00.000Z"}}
```

### POST /api/v1/accounting/classify-text

请求：`{ text: string }` 返回与 `accounting/classify` 的 `data` 结构一致（文本快速分类/回退）。

---

## 理财产品

### GET /api/v1/products

查询：`riskLevel|minYield|maxYield|minTermDays|maxTermDays`（可选）

### GET /api/v1/products/:id

### GET /api/v1/products/recommend

查询：`budget?termDays?riskPreference?` 返回 `RecommendedProduct[]`。

### GET /api/v1/products/estimate?productId=&amount=&termDays=

返回：`{ productId, estimate, termDays }`。

---

## 银行/支付 T+1 流水

### GET /api/v1/flows?date=YYYY-MM-DD

返回 `TransactionFlow[]`。

---

## 交易与消费

### GET /api/v1/transactions?page=&size=&from=&to=&category=

分页返回：`{ total, page, size, list }`。

### POST /api/v1/transactions

入参兼容两种形状：

- A（后端内部）：`{ amountCent, category, note, ts, source?, isAnomaly? }`
- B（前端提交）：`{ accountId?, time, type, amount, category, description?, remark? }`

映射规则：`amount -> amountCent`，`time -> ts`，`remark/description -> note`。

### PATCH /api/v1/transactions/:id

同上字段映射，部分更新。

### POST /api/v1/transactions/:id/delete

软删除一笔交易，返回：`{ transactionId, deleted: true }`。

### GET /api/v1/transactions/anomaly-scan?since=

返回：`{ anomalies: string[] }`（简单规则：30 天内金额>2000 元判异常）。

### GET /api/v1/consumption/summary?from=&to=

返回：

```ts
{
  byCategory: Array<{ category: string; amount: number; count: number }>, // amount 为分
  trend: Array<{ date: string; amount: number }>,
  frequency: Array<{ category: string; count: number }>
}
```

---

## 洞察与解读

### GET /api/v1/analysis/insights?from=&to=

返回：

```json
{"code":0,"data":{"summary":["主要支出集中在…","近7天共…笔"],"recommendation":"建议本周为…设置上限…"}}
```

说明：内部会基于分类汇总/趋势/频次与画像调用 AI 生成解读；若 AI 不可用，提供本地回退规则。

---

## AI 聊天

### POST /api/v1/ai/chat

请求示例：

```json
{"messages":[{"role":"user","content":"你好"}],"model":"deepseek-chat","temperature":0.3,"max_tokens":1024}
```

返回示例：

```json
{"code":0,"data":{"content":"你好！","raw":{}}}
```

环境依赖：必须设置 `DEEPSEEK_API_KEY`，缺失会返回 500。

## 提醒与激励

### GET /api/v1/reminders

### POST /api/v1/reminders

### POST /api/v1/reminders/:id

### POST /api/v1/reminders/:id/status

注：`config` 为对象（服务端以字符串存储），示例键：`frequency('DAY'|'WEEK'|'MONTH')`、`timeOfDay('HH:mm')`、`dueAt`。

### GET /api/v1/incentives

### POST /api/v1/incentives/claim

---

## 风险测评

### POST /api/v1/risk/assessment/start

返回：`{ assessmentId, status, questions[] }`

### POST /api/v1/risk/assessment/submit

请求：`{ assessmentId, answers: [{ qid, optionId }] }` 返回：`{ status:'COMPLETED', score, level }`

### GET /api/v1/risk/assessment/result?assessmentId=

---

## 报表

### GET /api/v1/reports/:type

`type` in `income-expense | balance-sheet | cashflow`。

---

## 账户（占位内存态）

### GET /api/v1/accounts

### POST /api/v1/accounts

### POST /api/v1/accounts/:id

### POST /api/v1/accounts/:id/delete

---

## NLP 意图识别

### POST /api/v1/intent/recognize

请求：`{ text }` 返回：`IntentItem[]`（关键词规则）。

---

## 审计日志上报

### POST /api/v1/audit/batch

请求：`{ items: Array<{ ts:number; action:string; detail?:any }> }` 返回 `{ accepted: number }`。

## 规划生成

### POST /api/v1/plan/generate

请求：`{ target: string, budget?: number, deadline?: string, constraints?: string[] }`

返回：

```json
{"code":0,"data":{"plans":[{"name":"基础方案","rationale":"…","steps":["…"],"checkpoints":["…"]}]}}
```

说明：若 AI 不可用，后端返回稳健的模板方案；前端可“一键采纳”写入 `/plans`。

---

## 规划方案 CRUD

### GET /api/v1/plans

### POST /api/v1/plans

### POST /api/v1/plans/:id

### POST /api/v1/plans/:id/delete

返回与字段参考前端 `src/api/types.ts` 中的 `PlanItem`。

## cURL 速查

- 票据分类：

```bash
curl -X POST "$BASE/api/v1/accounting/classify" \
  -F "image=@/path/bill1.jpg" -F "image=@/path/bill2.jpg"
```

- 新增交易（前端形状）：

```bash
curl -X POST "$BASE/api/v1/transactions" -H "Content-Type: application/json" \
  -d '{"time":"2025-11-13T10:00:00Z","amount":2599,"category":"餐饮","description":"午餐","remark":"公司食堂"}'
```

- AI 聊天：

```bash
curl -X POST "$BASE/api/v1/ai/chat" -H "Content-Type: application/json" \
  -d '{"messages":[{"role":"user","content":"你好"}]}'
```

---

## 对齐说明

- 路径、字段与前端封装一致；若后端需改名，请同步告知以更新 `endpoints.ts` 与类型。
- 所有时间字段均为 ISO8601 字符串（UTC）；前端负责本地化展示。
- 金额统一为分（Int）；前端输入“元”会转换后再提交。
